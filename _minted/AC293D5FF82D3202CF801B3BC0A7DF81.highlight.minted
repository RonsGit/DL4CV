\begin{MintedVerbatim}[commandchars=\\\{\}]
			\PYG{c+c1}{\PYGZsh{} Three\PYGZhy{}stage training of Qwen\PYGZhy{}VL (schematic)}
			
			\PYG{c+c1}{\PYGZsh{} Init}
			\PYG{n}{vit} \PYG{o}{=} \PYG{n}{OpenCLIP\PYGZus{}ViT\PYGZus{}bigG}\PYG{p}{(}\PYG{p}{)}
			\PYG{n}{llm} \PYG{o}{=} \PYG{n}{Qwen7B}\PYG{p}{(}\PYG{p}{)}                 \PYG{c+c1}{\PYGZsh{} frozen in Stage 1}
			\PYG{n}{adapter} \PYG{o}{=} \PYG{n}{CrossAttnAdapter}\PYG{p}{(}    \PYG{c+c1}{\PYGZsh{} 1\PYGZhy{}layer, M=256 learnable queries}
			\PYG{n}{num\PYGZus{}queries}\PYG{o}{=}\PYG{l+m+mi}{256}\PYG{p}{,} \PYG{n}{use\PYGZus{}2d\PYGZus{}abs\PYGZus{}pe}\PYG{o}{=}\PYG{k+kc}{True}
			\PYG{p}{)}
			
			\PYG{c+c1}{\PYGZsh{} Stage 1: Pretraining (224x224)}
			\PYG{n}{llm}\PYG{o}{.}\PYG{n}{freeze}\PYG{p}{(}\PYG{p}{)}
			\PYG{k}{for} \PYG{n}{batch} \PYG{o+ow}{in} \PYG{n}{pretrain\PYGZus{}loader}\PYG{p}{(}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{224}\PYG{p}{)}\PYG{p}{:}
				\PYG{n}{imgs}\PYG{p}{,} \PYG{n}{texts} \PYG{o}{=} \PYG{n}{batch}
				\PYG{n}{F} \PYG{o}{=} \PYG{n}{vit}\PYG{p}{(}\PYG{n}{imgs}\PYG{p}{)}                      \PYG{c+c1}{\PYGZsh{} patch features}
				\PYG{n}{H} \PYG{o}{=} \PYG{n}{adapter}\PYG{o}{.}\PYG{n}{compress}\PYG{p}{(}\PYG{n}{F}\PYG{p}{)}            \PYG{c+c1}{\PYGZsh{} M x d\PYGZus{}h tokens}
				\PYG{n}{tokens} \PYG{o}{=} \PYG{n}{wrap\PYGZus{}img\PYGZus{}tokens}\PYG{p}{(}\PYG{n}{H}\PYG{p}{,} \PYG{n}{texts}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} \PYGZlt{}img\PYGZgt{} ... \PYGZlt{}/img\PYGZgt{} + text}
				\PYG{n}{loss} \PYG{o}{=} \PYG{n}{autoregressive\PYGZus{}ce}\PYG{p}{(}\PYG{n}{llm}\PYG{p}{,} \PYG{n}{tokens}\PYG{p}{)}
				\PYG{n}{update}\PYG{p}{(}\PYG{n}{vit}\PYG{p}{,} \PYG{n}{adapter}\PYG{p}{)}
			
			\PYG{c+c1}{\PYGZsh{} Stage 2: Multi\PYGZhy{}task pretraining (448x448)}
			\PYG{n}{llm}\PYG{o}{.}\PYG{n}{unfreeze}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;} \PYG{n}{vit}\PYG{o}{.}\PYG{n}{unfreeze}\PYG{p}{(}\PYG{p}{)}
			\PYG{k}{for} \PYG{n}{batch} \PYG{o+ow}{in} \PYG{n}{multitask\PYGZus{}loader}\PYG{p}{(}\PYG{n}{resolution}\PYG{o}{=}\PYG{l+m+mi}{448}\PYG{p}{,} \PYG{n}{seq\PYGZus{}len}\PYG{o}{=}\PYG{l+m+mi}{2048}\PYG{p}{)}\PYG{p}{:}
				\PYG{n}{imgs}\PYG{p}{,} \PYG{n}{multimodal\PYGZus{}tokens} \PYG{o}{=} \PYG{n}{batch}    \PYG{c+c1}{\PYGZsh{} interleaved image\PYGZhy{}text}
				\PYG{n}{F} \PYG{o}{=} \PYG{n}{vit}\PYG{p}{(}\PYG{n}{imgs}\PYG{p}{)}
				\PYG{n}{H} \PYG{o}{=} \PYG{n}{adapter}\PYG{o}{.}\PYG{n}{compress}\PYG{p}{(}\PYG{n}{F}\PYG{p}{)}
				\PYG{n}{tokens} \PYG{o}{=} \PYG{n}{interleave}\PYG{p}{(}\PYG{n}{H}\PYG{p}{,} \PYG{n}{multimodal\PYGZus{}tokens}\PYG{p}{)}
				\PYG{n}{loss} \PYG{o}{=} \PYG{n}{autoregressive\PYGZus{}ce}\PYG{p}{(}\PYG{n}{llm}\PYG{p}{,} \PYG{n}{tokens}\PYG{p}{)}
				\PYG{n}{update}\PYG{p}{(}\PYG{n}{vit}\PYG{p}{,} \PYG{n}{adapter}\PYG{p}{,} \PYG{n}{llm}\PYG{p}{)}
			
			\PYG{c+c1}{\PYGZsh{} Stage 3: Supervised finetuning (instruction/chat)}
			\PYG{n}{vit}\PYG{o}{.}\PYG{n}{freeze}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;} \PYG{n}{llm}\PYG{o}{.}\PYG{n}{unfreeze}\PYG{p}{(}\PYG{p}{)}
			\PYG{k}{for} \PYG{n}{batch} \PYG{o+ow}{in} \PYG{n}{sft\PYGZus{}loader}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
				\PYG{n}{imgs}\PYG{p}{,} \PYG{n}{chat\PYGZus{}tokens} \PYG{o}{=} \PYG{n}{batch}
				\PYG{n}{F} \PYG{o}{=} \PYG{n}{vit}\PYG{p}{(}\PYG{n}{imgs}\PYG{p}{)}
				\PYG{n}{H} \PYG{o}{=} \PYG{n}{adapter}\PYG{o}{.}\PYG{n}{compress}\PYG{p}{(}\PYG{n}{F}\PYG{p}{)}
				\PYG{n}{tokens} \PYG{o}{=} \PYG{n}{interleave}\PYG{p}{(}\PYG{n}{H}\PYG{p}{,} \PYG{n}{chat\PYGZus{}tokens}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} includes boxes \PYGZlt{}box\PYGZgt{}...\PYGZlt{}/box\PYGZgt{}}
				\PYG{n}{loss} \PYG{o}{=} \PYG{n}{autoregressive\PYGZus{}ce}\PYG{p}{(}\PYG{n}{llm}\PYG{p}{,} \PYG{n}{tokens}\PYG{p}{)}
				\PYG{n}{update}\PYG{p}{(}\PYG{n}{adapter}\PYG{p}{,} \PYG{n}{llm}\PYG{p}{)}
\end{MintedVerbatim}
